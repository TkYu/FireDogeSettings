"use strict";(function(){"use strict";var app=angular.module("App",["ngMaterial","pascalprecht.translate"]);app.config(["$mdThemingProvider",function($mdThemingProvider){$mdThemingProvider.theme("default").primaryPalette("blue");$mdThemingProvider.theme("beta").primaryPalette("indigo")}]);app.config(["$translateProvider",function($translateProvider){$translateProvider.translations("zhcn",{UI:{ActionNames:{"append-command":"追加参数","base-setting":"杂项设置","check-update":"Firefox/FireDoge 更新","end-run":"关闭时运行","gesture-action":"手势列表","gesture-sync":"手势同步","key-transform":"按键转换","mouse-gesture":"鼠标手势","start-run":"启动时运行","ui-enhance":"界面增强"},ParamNames:{SendKeys:"发送按键",Window:"窗口控制",OpenUrl:"打开网址",RunApp:"打开程序",CopyToClipboard:"复制到剪贴板",Min:"最小化",Max:"最大化/还原",Topmost:"置顶/取消置顶",CurrURL:"当前网页URL",CurrDir:"当前程序目录",CurrTimestamp:"当前时间戳"},Controls:{AppendCommand:{description:'这里定义的<a href="https://www.baidu.com/s?wd=firefox命令行参数" target="_blank">Firefox命令行参数</a>，可在Firefox启动时自动插入',name:"追加参数"},BlankNewTabChecked:{description:"可以去除最常访问缩略图，并且保留主题效果",name:"空白新标签页面"},BookMarkNewTabChecked:{description:"新标签页中打开书签",name:"新标签打开书签"},BossKey:{description:"按下老板键后可隐藏所有浏览器窗口，再次按下即可恢复",name:"老板键："},Branch:{description:"要检查更新的分支",name:"更新版本：",Stable:"稳定版 Stable",Beta:"测试版 Beta",Dev:"开发版 Dev",Nightly:"毎晩 Nightly",ESR:"长期支持版 ESR"},DPI:{description:"如果界面增强功能异常，显示缩放不是100%的用户，应该修改为系统DPI",name:"系统DPI："},DisableWebConfig:{description:"关闭本Web设置功能",name:"停用WEB设置"},DoubleClickCloseTabChecked:{description:"直接在标签上双击就可以关闭页面",name:"双击关闭标签页"},EndRun:{description:"这里的程序会在Firefox关闭时启动（例如运行taskkill命令结束进程）",name:"关闭时运行"},FrontNewTabChecked:{description:"界面增强",name:"前台打开新标签"},GestureResultChecked:{description:"是否显示识别结果",name:"显示结果"},GestureSensitive:{description:"数值越低成功率越高但错误率也高，反之亦然",name:"灵敏度："},GestureTrackChecked:{description:"是否显示手势轨迹",name:"显示轨迹"},HandleMenuChecked:{description:"尝试处理通过菜单打开书签，如有副作用请关闭",name:"处理弹出菜单"},HostsDownload:{description:"",name:"订阅："},HostsPath:{description:"",name:"保存位置"},HostsSwitchChecked:{description:"启用后才会打开hosts功能",name:"启用"},HoverActivateTabChecked:{description:"鼠标悬停在标签上一定时间将会自动激活标签页",name:"悬停激活标签页"},HoverActivateTabDelay:{description:"悬停多久后激活标签页，单位毫秒",name:"悬停时间："},HoverTabSwitchChecked:{description:"鼠标悬停在标签栏时，滚动滚轮可切换标签",name:"悬停快速标签切换"},KeepLastTabChecked:{description:"通过新建一个标签实现，请注意在手动点击关闭按钮时无法阻止",name:"防止关闭最后的标签时关闭整个浏览器"},KeyIgnoreEditChecked:{description:"即使光标在编辑框中依然转换按键",name:"忽略编辑框"},KeyRepeatChecked:{description:"按下按键不放开，是否重复识别",name:"识别重复"},KeyTransformChecked:{description:"启用后才会转换按键",name:"启用"},KillAtEndChecked:{description:"在Firefox关闭时自动结束这些的程序",name:"自动结束运行程序"},MakePortableChecked:{description:'开启可以防止更换电脑、重装系统时个人设置丢失，<span style="color: red">Firefox不会像Chrome那样更换电脑导致用户文件失效，但是不支持多实例同时运行。</span>',name:"便携化"},MouseGestureChecked:{description:'关闭后才能使用扩展程序的鼠标手势（还要关闭<a href="#right-tab-switch">右键快速标签切换</a>）',name:"启用"},MouseGestureColor:{description:"",name:"手势颜色："},NotBlankTabChecked:{description:"当前页面是新标签页时，上面两个选项（新标签页中打开书签、新标签页中打开网址）不生效",name:"新标签页不生效"},OpenUrlNewTabChecked:{description:"地址栏输入的网址在新标签中打开（通过监控回车键）",name:"新标签打开网址"},RemoveDevelopErrorChecked:{description:"如果使用开发者模式加载扩展程序，打开firefox的时候会有警告，此选项可以关闭警告",name:"移除开发者模式警告"},RemoveUpdateErrorChecked:{description:"离线包不带更新程序，点开firefox关于时会有更新出错提示，此选项可关闭出错提示",name:"移除更新错误"},RightClickCloseTabChecked:{description:"开启此选项时，按住 <kbd>SHIFT</kbd> 再点击右键可以恢复打开菜单",name:"右键关闭标签页"},RightTabSwitchChecked:{description:"按住鼠标右键时，滚动滚轮可切换标签（这个功能会影响扩展程序的鼠标手势，但FireDoge手势不受影响）",name:"右键快速标签切换"},StartRun:{description:"这里的程序会随Firefox一起启动，如果路径（包括变量展开后）包含空格，需要用双引号括起来",name:"启动时运行"},SyncToken:{description:"输入手势同步Token可以在不同设备之间同步手势",name:"手势同步Token"},TrackArrowChecked:{description:"手势轨迹是否绘制为箭头",name:"轨迹箭头"},TrackThickness:{description:"鼠标手势的轨迹粗细",name:"轨迹粗细："},TrainingModeChecked:{description:"启用时遇到无法识别的手势将会添加为新手势",name:"学习模式"},TransformList:{description:"启用后才会转换按键",name:"按键转换"}},InnerTexts:{AppendCommandL1:'这里定义的<a href="https://www.baidu.com/s?wd=firefox命令行参数" target="_blank">Firefox命令行参数</a>，可在Firefox启动时自动插入',AppendCommandL2:"输入您要追加的参数",EndRunL1:"这里的程序会在浏览器关闭时启动（隐藏执行，用于执行一些清理工作，例如运行taskkill命令结束进程）",EndRunL2:"输入您要关闭时运行的程序",HelloL1:'如果喜欢FireDoge，可以前往 <a class="alert-link" href="https://github.com/TkYu/FireDoge" target="_blank">GitHub</a> 给个Star',HelloL2:"路径支持 <code>%appdata%</code> 这样的环境变量，特别的 <code>%app%</code> 代表程序当前所在目录",HelloL3:"部分设置需要重启浏览器才能生效，删除 FireDoge.ini 可以重置为默认设置",HelloL4:'如果遇到问题，可以前往 <a class="alert-link" href="https://github.com/TkYu/FireDoge/issues" target="_blank">GitHub Issue页面</a> 展开讨论',HelloL5:"点我打开 FireDoge.ini 所在的文件夹",HelloL6:"点我重启Firefox",StartRunL1:'这里的程序会随浏览器一起启动，<span style="color: red">如果路径（包括变量展开后）包含空格，需要用双引号括起来</span>',StartRunL2:"输入您要启动时运行的程序",TransListL1:"定义<kbd>F3=Ctrl+Tab</kbd>即可在按下<kbd>F3</kbd>时变为<kbd>Ctrl+Tab</kbd>",TransListL2:"输入您要转换的按键",GestureL1:"请先在上方开启鼠标手势",HostsL1:'网友提供的hosts下载地址，hosts文件可以提供域名到IP的映射关系，这个功能不会影响系统hosts，如果还是无法访问某些网站，请联系hosts提供者反馈。<span style="color: black;">程序每天会更新hosts一次</span>',UpdateL1:'您当前使用的 <span style="color: blue">{{product}}</span>({{version}}) 线上版本为：<span style="color: green">{{nversion}}</span>'},PText:{alertAddNew:"手势识别已关闭，请开始绘制手势，接下来画出的手势将会被添加。请注意和已有手势保持区别，否则会影响手势识别率。添加完成之后点击确定按钮刷新列表。",alertUnavailable:"你现在无法通过本界面修改FireDoge设置 请注意检查：是否开启全局代理、VPN 是否被杀毒软件、防火墙拦截 是否被去广告扩展、软件拦截。",alertUpdate:"Firefox/FireDoge已有新版本，是否立即更新？",alertExportDiag:"点击确定按钮您将导出当前FireDoge环境的诊断信息，请您在上传该文件之前检查并确保里面没有包含您不想公布的信息！",alertCancelButtonText:"取消",alertSaveButtonText:"保存",alertOkButtonText:"确定",alertTitle:"请注意",toastSaved:"配置已保存！",toastSaveFailed:"保存失败！"},SectionNames:{Basic:"基本设置",Enhancement:"手势增强",Others:"其他",StartEnd:"启动/关闭"},ButtonText:{Add:"新增",AddGesture:"添加手势",ExportDiagnostic:"导出诊断报告",Sync:"同步",Update:"点我更新"},Title:"配置FireDoge",GestureEdit:{Title:"编辑手势",Close:"关闭窗口",Param:"参数",Shortcut:"快捷键",WindowParam:"窗体参数",GestureName:"手势名",GestureAction:"手势动作"}}}).registerAvailableLanguageKeys(["en","zhcn","zhtw"],{"en_*":"en",zh_CN:"zhcn",zh_TW:"zhtw",zh_HK:"zhtw"}).useStaticFilesLoader({prefix:"i18n/locale-",suffix:".json"}).useSanitizeValueStrategy("escapeParameters").preferredLanguage("zhcn")}]);app.directive("colorcase",function(){function ToHex(c){c=parseInt(c);var hex=c.toString(16);return hex.length==1?"0"+hex:hex}return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$formatters.push(function(value){var a=parseInt(value.substring(0,2),16);var r=parseInt(value.substring(2,4),16);var g=parseInt(value.substring(4,6),16);var b=parseInt(value.substring(6,8),16);return"rgba("+r+","+g+","+b+","+(a/255).toFixed(2).replace(".00","")+")"});ngModel.$parsers.push(function(value){var rgx=/rgba\((\d+),(\d+),(\d+),([\d.]+)\)/i;var match=rgx.exec(value);console.log(match.length);if(match.length===5)return(ToHex(parseFloat(match[4])*255)+ToHex(match[1])+ToHex(match[2])+ToHex(match[3])).toUpperCase();else return"C8008BFB"})}}});app.controller("AppCtrl",["$scope","$location","$window","$http","$timeout","$anchorScroll","$httpParamSerializerJQLike","$mdSidenav","$mdDialog","$mdToast","$translate","$rootScope",function($scope,$location,$window,$http,$timeout,$anchorScroll,$httpParamSerializerJQLike,$mdSidenav,$mdDialog,$mdToast,$translate,$rootScope){const baseAddress="http://127.0.0.1";const minPort=2e4;const maxPort=20005;const saveInterval=2e3;var currentPort=0;var currentChcp=936;var downloadLink={FD:"",FDSha1:"",FF:"",FFSha1:""};var queue={};const configKeys={DoubleClickCloseTabChecked:{section:"UIEnhancements",name:"DoubleClickCloseTab"},RightClickCloseTabChecked:{section:"UIEnhancements",name:"CloseTabByRightClick"},HoverActivateTabChecked:{section:"UIEnhancements",name:"ActivateTabByHover"},HoverActivateTabDelay:{section:"UIEnhancements",name:"HoverDelay"},HoverTabSwitchChecked:{section:"UIEnhancements",name:"SwitchTabByHover"},RightTabSwitchChecked:{section:"UIEnhancements",name:"SwitchTabByHoldRightButton"},DPI:{section:"UIEnhancements",name:"DPI"},BossKey:{section:"General",name:"BossKey"},KillAtEndChecked:{section:"General",name:"AutoTerminate"},MakePortableChecked:{section:"General",name:"Portable"},DisableWebConfig:{section:"General",name:"WebUIDisabled"},KeyTransformChecked:{section:"KeyTransformation",name:"Enabled"},KeyRepeatChecked:{section:"KeyTransformation",name:"DuplicateKeyAccepted"},KeyIgnoreEditChecked:{section:"KeyTransformation",name:"IgnoreAtEditBox"},AppendCommand:{section:"AppendParams",name:null},StartRun:{section:"RunAtStartup",name:null},EndRun:{section:"RunAtEnd",name:null},TransformList:{section:"KeyTransformationList",name:null},MouseGestureChecked:{section:"Gesture",name:"Enabled"},MouseGestureColor:{section:"Gesture",name:"Colour"},GestureResultChecked:{section:"Gesture",name:"ShowResult"},GestureTrackChecked:{section:"Gesture",name:"ShowTrail"},TrackArrowChecked:{section:"Gesture",name:"ShowArrow"},TrackThickness:{section:"Gesture",name:"Weight"},TrainingModeChecked:{section:"Gesture",name:"TrainMode"},GestureSensitive:{section:"Gesture",name:"Threshold"},Branch:{section:"Update",name:"Branch"},SyncToken:{section:"Gesture",name:"SyncToken"}};const gestureConfigs={Actions:[{name:"SendKeys",value:"SendKeys"},{name:"Window",value:"Window"},{name:"OpenUrl",value:"OpenUrl"},{name:"RunApp",value:"RunApp"},{name:"CopyToClipboard",value:"CopyToClipboard"}],WindowParams:[{name:"Min",value:"0"},{name:"Max",value:"1"},{name:"Topmost",value:"2"}],Params:[{name:"CurrURL",value:"{CURRENT_URL}"},{name:"CurrDir",value:"{CURRENT_APPDIR}"},{name:"CurrTimestamp",value:"{CURRENT_TIMESTAMP}"}]};$scope.IsOkay=false;$scope.Busy=true;$scope.theme="default";$scope.configs={DoubleClickCloseTabChecked:false,RightClickCloseTabChecked:false,HoverActivateTabChecked:false,HoverActivateTabDelay:1,HoverTabSwitchChecked:false,RightTabSwitchChecked:false,DPI:2,BossKey:"",KillAtEndChecked:false,MakePortableChecked:false,DisableWebConfig:false,KeyTransformChecked:false,KeyRepeatChecked:false,KeyIgnoreEditChecked:false,AppendCommand:[],StartRun:[],EndRun:[],TransformList:[],MouseGestureChecked:false,MouseGestureColor:"",GestureResultChecked:false,GestureTrackChecked:false,TrackArrowChecked:false,TrackThickness:"",TrainingModeChecked:false,GestureSensitive:"",Branch:"",SyncToken:""};$scope.current={IsLoadingLanguage:false,Transform:"",AppendCommand:"",StartRun:"",EndRun:"",Hosts:["https://raw.githubusercontent.com/racaljk/hosts/master/hosts","https://raw.githubusercontent.com/sy618/hosts/master/FQ","https://raw.githubusercontent.com/vokins/yhosts/master/hosts","https://raw.githubusercontent.com/Lerist/Go-Hosts/master/hosts","https://raw.githubusercontent.com/googlehosts/hosts/master/hosts-files/hosts"],InputedHostValue:"",GestureList:[],LocalFDVersion:"",OnlineFDVersion:"NaN",LocalFFVersion:"",OnlineFFVersion:"NaN",Arch:false,NeedUpdate:false};$scope.uidata={title:"Title",toolbar:{buttons:[{name:"AddNew",icon:"add",link:"#"}],menus:[{name:"Language",icon:"language",width:"4",languages:[{name:"简体中文",icon:"desktop_mac",value:"zhcn"},{name:"繁體中文",icon:"desktop_mac",value:"zhtw"},{name:"English",icon:"desktop_mac",value:"en"}]}]},sidenav:{sections:[{name:"Basic",expand:true,actions:[{icon:"extension",name:"ui-enhance"},{icon:"explore",name:"base-setting"}]},{name:"StartEnd",expand:true,actions:[{icon:"announcement",name:"append-command"},{icon:"flight_takeoff",name:"start-run"},{icon:"flight_land",name:"end-run"}]},{name:"Enhancement",expand:true,actions:[{icon:"reorder",name:"key-transform"},{icon:"pan_tool",name:"mouse-gesture"},{icon:"thumbs_up_down",name:"gesture-action"},{icon:"backup",name:"gesture-sync"}]},{name:"Others",expand:true,actions:[{icon:"update",name:"check-update"}]}]},pText:{alertOkButtonText:"",alertCancelButtonText:"",alertSaveButtonText:"",alertUnavailable:"",alertUpdate:"",alertTitle:"",alertExportDiag:"",alertAddNew:"",toastSaved:"",toastSaveFailed:""}};var keys=Object.keys($scope.uidata.pText).map(function(x){return"UI.PText."+x});$rootScope.$on("$translateChangeSuccess",function(){$translate(keys).then(function(translations){for(var key in $scope.uidata.pText){$scope.uidata.pText[key]=translations["UI.PText."+key]}})});$rootScope.$on("$translateLoadingStart",function(event){$scope.current.IsLoadingLanguage=true});$rootScope.$on("$translateLoadingSuccess",function(event){$scope.current.IsLoadingLanguage=false});for(var key in $scope.uidata.pText){$scope.uidata.pText[key]=$translate.instant("UI.PText."+key)}function toHex(c){c=parseInt(c);var hex=c.toString(16);return hex.length==1?"0"+hex:hex}function toRGBA(v){var a=parseInt(v.substring(0,2),16);var r=parseInt(v.substring(2,4),16);var g=parseInt(v.substring(4,6),16);var b=parseInt(v.substring(6,8),16);return"rgba("+r+","+g+","+b+","+(a/255).toFixed(2).replace(".00","")+")"}function alertInternal(message){var dialog=$mdDialog.alert().parent(angular.element(document.querySelector("#popupContainer"))).title($scope.uidata.pText.alertTitle).textContent(message).ariaLabel(message).clickOutsideToClose(false).ok($scope.uidata.pText.alertOkButtonText);$mdDialog.show(dialog).then(function(){var popup=window.open(window.location.href,"_self","");popup.close()})}function ajax(url,data,callback,errorcallback){$http({url:url,method:"POST",data:$httpParamSerializerJQLike(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){callback(response)}).error(function(err){errorcallback(err)})}function delSection(data,callback){ajax(baseAddress+":"+currentPort+"/del_section",data,function(data){if(!callback){reloadGeneral();$scope.toast($scope.uidata.pText.toastSaved)}else callback()},function(err){alertInternal($scope.uidata.pText.toastSaveFailed)})}function addSection(data,callback){ajax(baseAddress+":"+currentPort+"/add_section",data,function(data){if(!callback){reloadGeneral();$scope.toast($scope.uidata.pText.toastSaved)}else callback()},function(err){alertInternal($scope.uidata.pText.toastSaveFailed)})}function setSetting(data,callback){ajax(baseAddress+":"+currentPort+"/set_setting",data,function(data){if(!callback){reloadGeneral()}else callback()},function(err){alertInternal("配置失败！")})}function addGesture(event){$http.post(baseAddress+":"+currentPort+"/add_gesture",{}).success(function(data){var confirm=$mdDialog.alert().title($scope.uidata.alertTitle).textContent($scope.uidata.pText.alertAddNew).ariaLabel($scope.uidata.pText.alertAddNew).targetEvent(event).ok($scope.uidata.pText.alertOkButtonText);$mdDialog.show(confirm).then(function(){getGesture()})})}function delGesture(data){ajax(baseAddress+":"+currentPort+"/del_gesture",data,function(data){getGesture();$scope.toast($scope.uidata.pText.toastSaved)},function(err){alertInternal($scope.uidata.pText.toastSaveFailed)})}function getGesture(){$http.post(baseAddress+":"+currentPort+"/get_gestures",{}).success(function(data){var convert=new Array;data.forEach(function(element){var split=element[element.name].split("|");if(split.length===3){convert.push({image:element.img,name:split[0],action:split[1],param:split[2],key:element.name,display:split[1]==="Window"?getNameByValue(split[2]):split[2]})}});$scope.current.GestureList=convert})}const getNameByValueDics={0:"Min",1:"Max",2:"Topmost","{CURRENT_URL}":"CurrURL","{CURRENT_APPDIR}":"CurrDir","{CURRENT_TIMESTAMP}":"CurrTimestamp"};function getNameByValue(name){return getNameByValueDics[name]||name}function tryParseInt(data){try{var prs=parseInt(data);return isNaN(prs)?1:prs}catch(exception){return 1}}function setCookie(key,value){var expires=new Date;expires.setTime(expires.getTime()+2*24*60*60*1e3);document.cookie=key+"="+value+";path=/"+";expires="+expires.toUTCString()}function getCookie(key){var reg=new RegExp("(^|;) ?"+key+"=([^;]*)(;|$)");var keyValue=document.cookie.match(reg);return keyValue?keyValue[2]:null}function queryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)");var r=window.location.search.substr(1).match(reg);if(r!=null)return decodeURI(r[2]);return null}function reloadGeneral(){$http.post(baseAddress+":"+currentPort+"/get_setting",{}).success(function(data){fillData(data)})}function fillData(response){$scope.configs.DoubleClickCloseTabChecked=response["UIEnhancements"]["DoubleClickCloseTab"]==="1";$scope.configs.RightClickCloseTabChecked=response["UIEnhancements"]["CloseTabByRightClick"]==="1";$scope.configs.HoverActivateTabChecked=response["UIEnhancements"]["ActivateTabByHover"]==="1";$scope.configs.HoverActivateTabDelay=tryParseInt(response["UIEnhancements"]["HoverDelay"]);$scope.configs.HoverTabSwitchChecked=response["UIEnhancements"]["SwitchTabByHover"]==="1";$scope.configs.RightTabSwitchChecked=response["UIEnhancements"]["SwitchTabByHoldRightButton"]==="1";$scope.configs.DPI=tryParseInt(response["UIEnhancements"]["DPI"]);$scope.configs.BossKey=response["General"]["BossKey"];$scope.configs.KillAtEndChecked=response["General"]["AutoTerminate"]==="1";$scope.configs.MakePortableChecked=response["General"]["Portable"]==="1";$scope.configs.DisableWebConfig=response["General"]["WebUIDisabled"]==="1";$scope.configs.AppendCommand=response["AppendParams"];$scope.configs.StartRun=response["RunAtStartup"];$scope.configs.EndRun=response["RunAtEnd"];$scope.configs.KeyTransformChecked=response["KeyTransformation"]["Enabled"]==="1";$scope.configs.KeyRepeatChecked=response["KeyTransformation"]["DuplicateKeyAccepted"]==="1";$scope.configs.KeyIgnoreEditChecked=response["KeyTransformation"]["IgnoreAtEditBox"]==="1";$scope.configs.TransformList=response["KeyTransformationList"];$scope.configs.MouseGestureChecked=response["Gesture"]["Enabled"]==="1";$scope.configs.MouseGestureColor=response["Gesture"]["Colour"]||"C6337AB7";$scope.configs.GestureResultChecked=response["Gesture"]["ShowResult"]==="1";$scope.configs.GestureTrackChecked=response["Gesture"]["ShowTrail"]==="1";$scope.configs.TrackArrowChecked=response["Gesture"]["ShowArrow"]==="1";$scope.configs.TrackThickness=tryParseInt(response["Gesture"]["Weight"]);$scope.configs.TrainingModeChecked=response["Gesture"]["TrainMode"]==="1";$scope.configs.GestureSensitive=tryParseInt(response["Gesture"]["Threshold"]);$scope.configs.SyncToken=response["Gesture"]["SyncToken"];$scope.configs.Branch=response["Update"]["Branch"]||"Stable";if(response["arch"]!==undefined)$scope.current.Arch=response["arch"];$scope.current.LocalFDVersion=response["version"];$scope.current.LocalFFVersion=response["cversion"]}function findBasePort(){if(currentPort>maxPort){setCookie("currentPort",minPort);$scope.Busy=false;var dialog=$mdDialog.alert().parent(angular.element(document.querySelector("#popupContainer"))).title($scope.uidata.pText.alertTitle).textContent($scope.uidata.pText.alertUnavailable).ariaLabel($scope.uidata.pText.alertUnavailable).clickOutsideToClose(false).ok($scope.uidata.pText.alertOkButtonText);$mdDialog.show(dialog).then(function(){var popup=window.open(window.location.href,"_self","");popup.close()});return}var port=Math.floor(currentPort);$http({method:"POST",data:{},url:baseAddress+":"+port+"/get_setting",headers:{"Content-Type":"text/plain"}}).success(function(data){if(cmpVersions(data["version"],"1.1.0")<0){$window.location.href="http://pub.ccc.xxx/FireDogeSettings/fd_old/"}if(data["chcp"]&&data["chcp"]!==0&&data["chcp"]!=="0"){currentChcp=parseInt(data["chcp"])}else{if(navigator.language){if(navigator.language.indexOf("en-")===0){currentChcp=437}else if(navigator.language==="zh-TW"||navigator.language==="zh-HK"){currentChcp=950}}}if(currentChcp===437){$translate.use("en")}else if(currentChcp===950){$translate.use("zhtw")}fillData(data);if(parseInt(data["Update"]["CheckFD"])===1){checkFDVersion()}if(parseInt(data["Update"]["CheckFF"])===1){checkFFVersion()}currentPort=port;setCookie("currentPort",currentPort);jQuery(document).ready(function(){jQuery("#colorpicker").colorpicker("setValue",toRGBA($scope.configs.MouseGestureColor))});getGesture();startWatch();$scope.Busy=false;$scope.IsOkay=true;var ntd=queryString("add_gesture");if(ntd){addGesture(null)}}).error(function(err){currentPort+=.5;findBasePort()})}var showUpdated=false;function showUpdate(){var confirm=$mdDialog.confirm().title($scope.uidata.pText.alertTitle).textContent($scope.uidata.pText.alertUpdate).ariaLabel($scope.uidata.pText.alertUpdate).clickOutsideToClose(false).ok($scope.uidata.pText.alertOkButtonText).cancel($scope.uidata.pText.alertCancelButtonText);showUpdated=true;$mdDialog.show(confirm).then(function(){showUpdated=false;if(cmpVersions($scope.current.LocalFDVersion,"1.1.0")>=0){$scope.doUpdate(null)}else{$window.location.href="https://github.com/TkYu/FireDoge"}},function(){showUpdated=false})}function checkFFVersion(){}function checkFDCallback(){var cmp=cmpVersions($scope.current.LocalFDVersion,$scope.current.OnlineFDVersion);if(cmp>0){$scope.theme="beta";$scope.current.NeedUpdate=false}else if(cmp<0){$scope.Busy=false;if(cmpVersions($scope.current.LocalFDVersion,"1.0.9")>=0){$scope.current.NeedUpdate=true}showUpdate()}else{$scope.current.NeedUpdate=false}}function checkFDVersion(){var arch=$scope.current.Arch?"x64":"x86";if(getCookie("fdInfoCached")&&$window.localStorage.getItem("fd")){var cachedGC=JSON.parse($window.localStorage.getItem("fd"));$scope.current.OnlineFDVersion=cachedGC.version;downloadLink.FD=cachedGC["link"][arch].url;downloadLink.FDSha1=cachedGC["link"][arch].sha1;checkFDCallback()}else{$window.localStorage.removeItem("fd");$http.get("https://api.pzhacm.org/iivb/fd.json").success(function(data){$window.localStorage.setItem("fd",JSON.stringify(data));var expires=new Date;expires.setTime(expires.getTime()+10*60*1e3);document.cookie="fdInfoCached=true;path=/;expires="+expires.toUTCString();$scope.current.OnlineFDVersion=data.version;downloadLink.FD=data["link"][arch].url;downloadLink.FDSha1=data["link"][arch].sha1;checkFDCallback()})}}function cmpVersions(a,b){var i,diff;var regExStrip0=/(\.0+)+$/;var segmentsA=a.replace(regExStrip0,"").split(".");var segmentsB=b.replace(regExStrip0,"").split(".");var l=Math.min(segmentsA.length,segmentsB.length);for(i=0;i<l;i++){diff=parseInt(segmentsA[i],10)-parseInt(segmentsB[i],10);if(diff){return diff}}return segmentsA.length-segmentsB.length}function startWatch(){$scope.$watchCollection("configs",function(newValue,oldValue){for(var key in newValue){var sname=configKeys[key];if(sname.name===null||key==="DisableWebConfig")continue;var nvalue=newValue[key];var ovalue=oldValue[key];if(nvalue!==ovalue){if(sname===undefined){$scope.showAlert(null,"表单有误！","出错了！");return}var content={section:sname.section};if(sname.name!==null){content.name=sname.name}content.value=typeof nvalue==="boolean"?nvalue?"1":"0":nvalue;queue[key]=content}}});var saveSettings=function(){if(Object.getOwnPropertyNames(queue).length===0){$timeout(saveSettings,saveInterval);return}for(var key in queue){var value=queue[key];setSetting(value,function(){if(value.name==="Branch")checkFFVersion()})}queue={};$scope.toast($scope.uidata.pText.toastSaved);$timeout(saveSettings,saveInterval)};listenKeys();$timeout(saveSettings,saveInterval)}function listenKeys(){var hotkeys=[];var hotkeyCounter=0;var dom=document.getElementById("bosskey");function render(needSave){var h=hotkeys.map(function(e){return e.replace("Left","").replace("Right","").replace("Control","Ctrl").replace("Digit","").replace("Key","")});if(needSave){if(hotkeys.some(function(e){return e.length>1&&e.indexOf("Key")===0})){$scope.configs.BossKey=h.join("+")}else{dom.value=$scope.configs.BossKey}}else{dom.value=h.join("+")}}dom.addEventListener("keydown",function(e){e.preventDefault();if(e.ctrlKey===false&&e.altKey===false&&e.shiftKey===false)return;if(hotkeyCounter===0){hotkeys=[]}if(hotkeys.indexOf(e.code)===-1){if(hotkeys.some(function(e){return e.indexOf("Key")===0}))return;hotkeys.push(e.code);hotkeyCounter++}render(false)});dom.addEventListener("keyup",function(e){e.preventDefault();var index=hotkeys.indexOf(e.code);if(index!==hotkeys.length-1||hotkeys.length===1){hotkeyCounter=0}render(true)})}function addOrEditGesture(event,item){$mdDialog.show({controller:GestureEditController,templateUrl:"GestureEdit.tmpl.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:false,fullscreen:true,resolve:{parameters:function(){return{CurrentItem:item,Actions:gestureConfigs.Actions,WindowParams:gestureConfigs.WindowParams,Params:gestureConfigs.Params}},ajax:function(){return ajax}}}).then(function(ret){if(ret){if(ret==="ok"){getGesture();$scope.toast($scope.uidata.pText.toastSaved)}else{$scope.showAlert(null,ret,$scope.uidata.pText.alertTitle)}}},function(){})}function GestureEditController($scope,$mdDialog,$timeout,parameters,ajax){$scope.current={Image:parameters.CurrentItem.image,Actions:parameters.Actions,WindowParams:parameters.WindowParams,Params:parameters.Params,Name:parameters.CurrentItem.name||"新手势"+Date.parse((new Date).toString())/1e3,Action:parameters.CurrentItem.action||"SendKeys",WindowParam:parameters.CurrentItem.param||"0",HotKeyParam:parameters.CurrentItem.param||"Home",SelectedItem:"",SearchText:parameters.CurrentItem.param||"{CURRENT_APPDIR}"};switch(parameters.CurrentItem.action){case"SendKeys":$scope.current.HotKey=parameters.CurrentItem.param;break;case"Window":$scope.current.WindowParam=parameters.CurrentItem.param;break;case"OpenUrl":$scope.current.SearchText=parameters.CurrentItem.param;break;case"RunApp":$scope.current.SearchText=parameters.CurrentItem.param;break;case"CopyToClipboard":$scope.current.SearchText=parameters.CurrentItem.param;break;default:$mdDialog.hide("WTF");return}function listenKeys(dom){var hotkeys=[];var hotkeyCounter=0;function render(needSave){if(hotkeys.length===0)return;var h=hotkeys.map(function(e){return e.replace("Left","").replace("Right","").replace("Control","Ctrl").replace("Digit","").replace("Key","")});if(needSave){if(hotkeys.some(function(e){return e.length>1&&e.indexOf("Key")===0})){$scope.current.HotKey=h.join("+")}else{dom.value=$scope.current.HotKey}}else{dom.value=h.join("+")}}dom.addEventListener("keydown",function(e){if(hotkeys.length===1){if(hotkeys[0].indexOf("Control")===0&&e.keyCode===86){hotkeys=[];render(false);return}}if(e.ctrlKey===false&&e.altKey===false&&e.shiftKey===false){return}e.preventDefault();if(hotkeyCounter===0){hotkeys=[]}if(hotkeys.indexOf(e.code)===-1){if(hotkeys.some(function(e){return e.indexOf("Key")===0}))return;hotkeys.push(e.code);hotkeyCounter++}render(false)});dom.addEventListener("keyup",function(e){e.preventDefault();var index=hotkeys.indexOf(e.code);if(index!==hotkeys.length-1||hotkeys.length===1){hotkeyCounter=0}render(true)})}$scope.querySearch=function(query){var results=query?$scope.current.Params.filter(createFilterFor(query)):$scope.current.Params;return results};function createFilterFor(query){var lowercaseQuery=angular.lowercase(query);return function filterFn(state){var lowercaseParam=angular.lowercase(state.value);return lowercaseParam.indexOf(lowercaseQuery)>=0}}$scope.hide=function(){$mdDialog.hide()};$scope.cancel=function(){$mdDialog.cancel()};$scope.save=function(){var parameter={section:"GestureList",name:parameters.CurrentItem.key,value:$scope.current.Name+"|"+$scope.current.Action+"|"};switch($scope.current.Action){case"SendKeys":parameter.value+=$scope.current.HotKeyParam;break;case"Window":parameter.value+=$scope.current.WindowParam;break;case"OpenUrl":parameter.value+=$scope.current.SearchText;break;case"RunApp":parameter.value+=$scope.current.SearchText;break;case"CopyToClipboard":parameter.value+=$scope.current.SearchText;break;default:$mdDialog.hide("WTF");return}ajax(baseAddress+":"+currentPort+"/set_setting",parameter,function(data){$mdDialog.hide("ok")},function(err){$mdDialog.hide("WTF")})};var waitSkeyInput=function(){var dom=document.getElementById("skey");if(dom!==null){listenKeys(dom);return}$timeout(waitSkeyInput,100)};$timeout(waitSkeyInput,100)}$scope.changeLanguage=function(key){setCookie("lang",key);$translate.use(key)};$scope.openConfigFile=function(){$http.post(baseAddress+":"+currentPort+"/openconfig",{})};$scope.restartChrome=function(){$http.post(baseAddress+":"+currentPort+"/restart",{})};$scope.scrollTo=function(hash){var old=$location.hash();$location.hash(hash);$anchorScroll();$location.hash(old)};$scope.RaiseChanged=function(s,n,v){if(s===undefined||n===undefined||v===undefined){$scope.showAlert(null,"表单有误！","出错了！");return}var parameter={section:s,name:n,value:typeof v==="boolean"?v?"1":"0":v};console.log(parameter)};$scope.RaiseEvent=function(ev){var target=ev.target;if(!target){console.log(ev);return}var v=$scope.configs[target.attributes["ng-model"].value.replace("configs.","")];var parameter={section:target.attributes["data-section"].value,name:target.attributes["aria-label"].value,value:typeof v==="boolean"?v?"1":"0":v};if(!parameter.section||!parameter.name||v===undefined){$scope.showAlert(null,"表单有误！","出错了！");return}console.log(parameter)};$scope.RemoveTransform=function(item){var parameter={section:"KeyTransformationList",value:item};delSection(parameter)};$scope.AddTransform=function(){if($scope.current.Transform){var parameter={section:"KeyTransformationList",value:$scope.current.Transform};$scope.current.Transform="";addSection(parameter)}};$scope.RemoveAppendCommand=function(item){var parameter={section:"AppendParams",value:item};delSection(parameter)};$scope.AddAppendCommand=function(){if($scope.current.AppendCommand){var parameter={section:"AppendParams",value:$scope.current.AppendCommand};$scope.current.AppendCommand="";addSection(parameter)}};$scope.RemoveStartRun=function(item){var parameter={section:"RunAtStartup",value:item};delSection(parameter)};$scope.AddStartRun=function(){if($scope.current.StartRun){var parameter={section:"RunAtStartup",value:$scope.current.StartRun};$scope.current.StartRun="";addSection(parameter)}};$scope.RemoveEndRun=function(item){var parameter={section:"RunAtEnd",value:item};delSection(parameter)};$scope.AddEndRun=function(){if($scope.current.EndRun){var parameter={section:"RunAtEnd",value:$scope.current.EndRun};$scope.current.EndRun="";addSection(parameter)}};$scope.AddGesture=function(ev){addGesture(ev)};$scope.RemoveGesture=function(item){var parameter={name:item.key};delGesture(parameter)};$scope.EditGesture=function(ev,item){addOrEditGesture(ev,item)};$scope.toggleSidenav=function(menu){$mdSidenav(menu).toggle()};$scope.toast=function(message){var toast=$mdToast.simple().content(message).position("bottom right");$mdToast.show(toast)};$scope.showAlert=function(ev,text,title){$mdDialog.show($mdDialog.alert().parent(angular.element(document.querySelector("#popupContainer"))).clickOutsideToClose(true).title(title).textContent(text).ariaLabel("提示").clickOutsideToClose(false).ok($scope.uidata.alertOkButtonText).targetEvent(ev))};$scope.querySearch=function(query){var results=query?$scope.current.Hosts.filter(createFilterFor(query)):$scope.current.Hosts;return results};$scope.ExportDiagnostics=function(ev){var confirm=$mdDialog.confirm().title($scope.uidata.pText.alertTitle).textContent($scope.uidata.pText.alertExportDiag).ariaLabel("Diagnosic").targetEvent(ev).clickOutsideToClose(true).ok($scope.uidata.pText.alertOkButtonText).cancel($scope.uidata.pText.alertCancelButtonText);$mdDialog.show(confirm).then(function(){$http.get(baseAddress+":"+currentPort+"/get_diagnostics").success(function(data){var now=jQuery.now();var zip=new JSZip;zip.file("FireDogeDiag"+now+".json",JSON.stringify(data));zip.generateAsync({type:"blob"}).then(function(content){saveAs(content,"FireDogeDiag"+now+".zip")})})},function(){})};$scope.doUpdate=function(ev){if(ev)ev.target.disabled=true;var parameter={lv:$scope.current.LocalFFVersion,ov:$scope.current.OnlineFFVersion,clv:$scope.current.LocalFDVersion,cov:$scope.current.OnlineFDVersion,lff:downloadLink.FF,lfd:downloadLink.FD,sff:downloadLink.FFSha1,sfd:downloadLink.FDSha1};ajax(baseAddress+":"+currentPort+"/update",parameter,function(data){$scope.Busy=true;$scope.IsOkay=false},function(err){if(ev)ev.target.disabled=false})};function createFilterFor(query){var lowercaseQuery=angular.lowercase(query);return function filterFn(state){var lowercaseParam=angular.lowercase(state)
;return lowercaseParam.indexOf(lowercaseQuery)>=0}}if(getCookie("currentPort")===null){currentPort=minPort}else{try{currentPort=parseInt(getCookie("currentPort"))}catch(ex){currentPort=minPort}}var key=getCookie("lang");if(key){if(key==="en"||key==="zhcn"||key==="zhtw"){$translate.use(key)}}jQuery(document).ready(function(){jQuery.support.cors=true;var cpkr=jQuery("#colorpicker");cpkr.colorpicker({format:"rgba"});cpkr.colorpicker().on("changeColor",function(e){var v=e.color.toRGB();var clr=(toHex(v.a*255)+toHex(v.r)+toHex(v.g)+toHex(v.b)).toUpperCase();$scope.configs.MouseGestureColor=clr})});findBasePort()}])})();